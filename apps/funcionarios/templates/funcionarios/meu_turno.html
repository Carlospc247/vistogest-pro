{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Meu Painel de Turno: Ponto e Vendas{% endblock %}

{% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PontoPerfeito | Painel de Turno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <i data-feather="clock" class="text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800">PontoPerfeito</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'vendas:pdv' %}"
                        class="block rounded-md py-2 px-3 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800">
                        <h1 class="text-xl font-bold text-indigo-600"><i class="fas fa-cash-register mr-2"></i>PDV</h1>
                    </a>
                    <div class="bg-gray-100 px-3 py-1 rounded-full text-sm font-medium">
                        <span class="text-gray-500">Hoje:</span>
                        <span class="text-gray-800 font-semibold">{{ hoje|date:"d/m/Y" }}</span>
                    </div>
                    <div class="relative">
                        <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                            <i data-feather="user" class="text-indigo-600"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Welcome Banner -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 mb-8 text-white shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold">Olá, {{ funcionario.nome_completo|default:"Colaborador" }}!</h2>
                        <p class="opacity-90 mt-1">Bem-vindo ao seu painel de controle de ponto e vendas</p>
                    </div>
                    <div class="flex space-x-3">
                        {% if not fechamento_hoje %}
                        <button onclick="openModal()"
                            class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 transition-colors shadow-md flex items-center">
                            <i data-feather="lock" class="w-4 h-4 mr-2"></i>
                            Fechar Turno
                        </button>
                        {% else %}
                        <a href="{% url 'funcionarios:relatorio_fechamento' fechamento_hoje.pk %}"
                            class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition-colors shadow-md flex items-center">
                            <i data-feather="file-text" class="w-4 h-4 mr-2"></i>
                            Ver Relatório
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Dashboard Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Ponto Card -->
                <div class="glass-card rounded-xl shadow-md overflow-hidden lg:col-span-1">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i data-feather="clock" class="mr-2 text-indigo-600"></i>
                                Controle de Ponto
                            </h3>
                            <a href="{% url 'funcionarios:historico_ponto' funcionario_pk=funcionario.pk %}"
                                class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                                Histórico <i data-feather="chevron-right" class="ml-1 w-4 h-4"></i>
                            </a>
                        </div>

                        {% if funcionario %}
                        {% with num_pontos=pontos_hoje|length %}
                        <div class="space-y-4">
                            {% if num_pontos == 4 %}
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i data-feather="check-circle" class="text-green-600"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-green-800">Turno Completo</h4>
                                        <p class="text-sm text-green-600 mt-1">Todos os 4 pontos foram registrados hoje
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% elif num_pontos|divisibleby:"2" %}
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i data-feather="alert-circle" class="text-yellow-600"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-yellow-800">Próxima ação</h4>
                                        <p class="text-sm text-yellow-600 mt-1">Bater entrada</p>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i data-feather="alert-triangle" class="text-red-600"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-red-800">Próxima ação</h4>
                                        <p class="text-sm text-red-600 mt-1">Bater saída</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="flex items-center justify-between bg-gray-50 px-4 py-3 rounded-lg">
                                <span class="text-sm font-medium text-gray-500">Último registro</span>
                                <span class="text-sm font-semibold text-gray-700">
                                    {% if pontos_hoje %}{{ pontos_hoje.last.hora_registro|time:"H:i" }}{% else
                                    %}Nenhum{% endif %}
                                </span>
                            </div>

                            <div class="pt-2">
                                {% if num_pontos < 4 %} <button onclick="registrarPonto(this)"
                                    class="w-full flex items-center justify-center px-4 py-3 border border-transparent rounded-xl shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 pulse-animation">
                                    <i data-feather="clock" class="mr-2"></i>
                                    Bater Ponto Agora
                                    </button>
                                    {% else %}
                                    <button
                                        class="w-full flex items-center justify-center px-4 py-3 border border-transparent rounded-xl shadow-sm text-base font-medium text-white bg-gray-400 cursor-not-allowed">
                                        Turno Completo
                                    </button>
                                    {% endif %}
                            </div>
                        </div>
                        {% endwith %}
                        {% else %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i data-feather="alert-octagon" class="text-red-600"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-red-800">Perfil não encontrado</h4>
                                    <p class="text-sm text-red-600 mt-1">Contate o administrador do sistema</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Vendas Card & Chart -->
                <div class="glass-card rounded-xl shadow-md overflow-hidden lg:col-span-2 flex flex-col">
                    <div class="p-6 flex-1">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i data-feather="dollar-sign" class="mr-2 text-green-600"></i>
                                Desempenho de Vendas
                            </h3>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">HOJE</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <!-- Receita Direta -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm font-medium text-blue-800">Receita Direta</p>
                                <div class="text-xl font-bold text-blue-900 mt-1">
                                    {{ total_venda_direta_hoje|floatformat:2|intcomma }} Kz
                                </div>
                                <p class="text-xs text-blue-600 mt-1">{{ vendas_diretas_count }} transações</p>
                            </div>

                            <!-- Faturado a Crédito -->
                            <div class="bg-amber-50 rounded-lg p-4">
                                <p class="text-sm font-medium text-amber-800">Faturado a Crédito</p>
                                <div class="text-xl font-bold text-amber-900 mt-1">
                                    {{ total_faturado_credito_hoje|floatformat:2|intcomma }} Kz
                                </div>
                                <p class="text-xs text-amber-600 mt-1">Valor potencial</p>
                            </div>

                            <!-- Total -->
                            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg p-4 text-white">
                                <p class="text-sm font-medium opacity-90">Receita Bruta Total</p>
                                <div class="text-2xl font-bold mt-1">
                                    {{ total_receita_bruta_hoje|floatformat:2|intcomma }} Kz
                                </div>
                            </div>
                        </div>

                        <!-- Chart Area -->
                        <div class="relative h-64 w-full">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Registros de Ponto -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-4">
                            <i data-feather="list" class="mr-2 text-indigo-600"></i>
                            Registros de Ponto Hoje
                        </h3>

                        {% if pontos_hoje %}
                        <div class="space-y-3">
                            {% for ponto in pontos_hoje %}
                            <div
                                class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                <div class="flex items-center">
                                    <div class="bg-indigo-100 p-2 rounded-lg">
                                        <i data-feather="clock" class="text-indigo-600 w-4 h-4"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-700">
                                            {% if forloop.counter == 1 %}Entrada Manhã
                                            {% elif forloop.counter == 2 %}Saída Almoço
                                            {% elif forloop.counter == 3 %}Entrada Tarde
                                            {% elif forloop.counter == 4 %}Saída Final
                                            {% else %}Ponto Extra{% endif %}
                                        </p>
                                        <p class="text-xs text-gray-500">Registro #{{ forloop.counter }}</p>
                                    </div>
                                </div>
                                <span class="text-sm font-semibold text-gray-800">
                                    {{ ponto.hora_registro|time:"H:i" }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-8">
                            <i data-feather="clock" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <h4 class="mt-2 text-sm font-medium text-gray-900">Nenhum registro hoje</h4>
                            <p class="mt-1 text-sm text-gray-500">Seu primeiro ponto aparecerá aqui</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Próximas Escalas -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-4">
                            <i data-feather="calendar" class="mr-2 text-indigo-600"></i>
                            Próximas Escalas
                        </h3>

                        {% if proximas_escalas %}
                        <div class="space-y-3">
                            {% for escala in proximas_escalas %}
                            <div
                                class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
                                <div class="flex items-center">
                                    <div class="bg-purple-100 p-2 rounded-lg">
                                        <i data-feather="calendar" class="text-purple-600 w-4 h-4"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-700">
                                            {{ escala.data_trabalho|date:"l"|title }}, {{
                                            escala.data_trabalho|date:"d/m/Y" }}
                                        </p>
                                        <p class="text-xs text-gray-500">Dia de trabalho</p>
                                    </div>
                                </div>
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                    {{ escala.hora_inicio|time:"H:i" }} - {{ escala.hora_fim|time:"H:i" }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-8">
                            <i data-feather="calendar" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <h4 class="mt-2 text-sm font-medium text-gray-900">Nenhuma escala programada</h4>
                            <p class="mt-1 text-sm text-gray-500">Suas próximas escalas aparecerão aqui</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Fechamento de Turno -->
    <div id="modalFechamento" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                onclick="closeModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form action="{% url 'funcionarios:fechar_turno' %}" method="POST">
                    {% csrf_token %}
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div
                                class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                                <i data-feather="lock" class="text-indigo-600"></i>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                    Fechar Turno
                                </h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500 mb-4">
                                        Informe os valores em caixa e nas máquinas para realizar o fechamento.
                                    </p>

                                    <div class="space-y-4">
                                        <div>
                                            <label for="valor_caixa"
                                                class="block text-sm font-medium text-gray-700">Valor em Dinheiro
                                                (Kz)</label>
                                            <input type="number" step="0.01" name="valor_caixa" id="valor_caixa"
                                                class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                                placeholder="0.00" required>
                                        </div>
                                        <div>
                                            <label for="valor_tpa" class="block text-sm font-medium text-gray-700">Valor
                                                em TPA (Kz)</label>
                                            <input type="number" step="0.01" name="valor_tpa" id="valor_tpa"
                                                class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                                placeholder="0.00" required>
                                        </div>
                                        <div>
                                            <label for="valor_transferencia"
                                                class="block text-sm font-medium text-gray-700">Valor em Transferência
                                                (Kz)</label>
                                            <input type="number" step="0.01" name="valor_transferencia"
                                                id="valor_transferencia"
                                                class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                                placeholder="0.00" required>
                                        </div>
                                        <div>
                                            <label for="observacoes"
                                                class="block text-sm font-medium text-gray-700">Observações</label>
                                            <textarea name="observacoes" id="observacoes" rows="3"
                                                class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                            Confirmar Fechamento
                        </button>
                        <button type="button" onclick="closeModal()"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        // Modal functions
        function openModal() {
            document.getElementById('modalFechamento').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalFechamento').classList.add('hidden');
        }

        // Chart.js
        const ctx = document.getElementById('salesChart').getContext('2d');
        const salesData = JSON.parse('{{ sales_chart_data|escapejs }}');

        // Process data for chart
        const hours = Array.from({ length: 24 }, (_, i) => i);
        const dataPoints = hours.map(hour => {
            const found = salesData.find(d => d.hour === hour);
            return found ? found.total : 0;
        });

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hours.map(h => `${h}:00`),
                datasets: [{
                    label: 'Vendas por Hora (Kz)',
                    data: dataPoints,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Ponto functions (existing)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function registrarPonto(button) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registrando...';

            const csrftoken = getCookie('csrftoken');
            const pontoUrl = "{% url 'funcionarios:registrar_ponto' %}";

            fetch(pontoUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('success', `Ponto registrado com sucesso às ${data.horario}`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showNotification('error', data.message);
                        button.disabled = false;
                        button.innerHTML = '<i data-feather="clock" class="mr-2"></i> Bater Ponto Agora';
                        feather.replace();
                    }
                })
                .catch(error => {
                    showNotification('error', 'Erro na comunicação com o servidor');
                    button.disabled = false;
                    button.innerHTML = '<i data-feather="clock" class="mr-2"></i> Bater Ponto Agora';
                    feather.replace();
                });
        }

        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'
                }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            feather.replace();

            setTimeout(() => {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    </script>
</body>
{% endblock %}