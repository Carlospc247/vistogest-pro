{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .contas-receber-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: calc(100vh - 200px);
        border-radius: 12px;
        padding: 24px;
    }

    .resumo-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .resumo-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border-left: 4px solid;
        transition: transform 0.3s ease;
    }

    .resumo-card:hover {
        transform: translateY(-2px);
    }

    .resumo-card.total-pendente {
        border-left-color: #ef4444;
    }

    .resumo-card.vencidas {
        border-left-color: #dc2626;
    }

    .resumo-card.vencendo {
        border-left-color: #f59e0b;
    }

    .resumo-card.futuras {
        border-left-color: #10b981;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .status-vencida {
        background-color: #fef2f2;
        color: #b91c1c;
    }

    .dark .status-vencida {
        background-color: #7f1d1d;
        color: #fecaca;
    }

    .status-vencendo {
        background-color: #fffbeb;
        color: #d97706;
    }

    .dark .status-vencendo {
        background-color: #78350f;
        color: #fed7aa;
    }

    .status-futura {
        background-color: #f0fdf4;
        color: #166534;
    }

    .dark .status-futura {
        background-color: #14532d;
        color: #bbf7d0;
    }

    .btn-liquidar {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-liquidar:hover {
        background: linear-gradient(135deg, #0d9488 0%, #047857 100%);
        transform: translateY(-1px);
    }

    .filtros-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="contas-receber-container">
    <!-- Cabeçalho -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-coins mr-2"></i>{{ title }}
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
                Gerencie as faturas a crédito pendentes de pagamento
            </p>
        </div>
        <div class="flex space-x-3">
            <button onclick="atualizarDados()"
                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-all">
                <i class="fas fa-sync-alt mr-2"></i>Atualizar
            </button>
            <a href="{% url 'vendas:nova_fatura_credito' %}"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all">
                <i class="fas fa-plus mr-2"></i>Nova Fatura
            </a>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="resumo-cards">
        <div class="resumo-card total-pendente">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Total a Receber</h3>
                    <p class="text-2xl font-bold text-red-600" id="totalReceber">
                        {{ total_a_receber|floatformat:2 }} Kz
                    </p>
                    <p class="text-sm text-gray-500 mt-1">Valor total pendente</p>
                </div>
                <div class="text-red-500">
                    <i class="fas fa-exclamation-triangle text-3xl"></i>
                </div>
            </div>
        </div>

        <div class="resumo-card vencidas">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Vencidas</h3>
                    <p class="text-2xl font-bold text-red-700" id="faturas-vencidas">0</p>
                    <p class="text-sm text-gray-500 mt-1">Faturas em atraso</p>
                </div>
                <div class="text-red-700">
                    <i class="fas fa-calendar-times text-3xl"></i>
                </div>
            </div>
        </div>

        <div class="resumo-card vencendo">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Vencendo (7 dias)</h3>
                    <p class="text-2xl font-bold text-orange-600" id="faturas-vencendo">0</p>
                    <p class="text-sm text-gray-500 mt-1">Próximas ao vencimento</p>
                </div>
                <div class="text-orange-600">
                    <i class="fas fa-calendar-exclamation text-3xl"></i>
                </div>
            </div>
        </div>

        <div class="resumo-card futuras">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Futuras</h3>
                    <p class="text-2xl font-bold text-green-600" id="faturas-futuras">0</p>
                    <p class="text-sm text-gray-500 mt-1">Ainda não venceram</p>
                </div>
                <div class="text-green-600">
                    <i class="fas fa-calendar-check text-3xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filtros-container">
        <div class="flex flex-wrap gap-4 items-center">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status:</label>
                <select id="filtroStatus" onchange="filtrarFaturas()"
                    class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="">Todos</option>
                    <option value="vencida">Vencidas</option>
                    <option value="vencendo">Vencendo (7 dias)</option>
                    <option value="futura">Futuras</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cliente:</label>
                <input type="text" id="filtroCliente" placeholder="Nome do cliente" onkeyup="filtrarFaturas()"
                    class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div class="flex items-end">
                <button onclick="limparFiltros()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-eraser mr-1"></i>Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Tabela de Faturas -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="fas fa-file-invoice mr-2"></i>
                Faturas Pendentes
            </h3>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                    <tr>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Fatura
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Cliente
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Emissão
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Vencimento
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Valor Total
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Valor Pago
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Saldo
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Status
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Ações
                        </th>
                    </tr>
                </thead>
                <tbody id="faturas-tbody"
                    class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for fatura in faturas_pendentes %}
                    <tr id="fatura-row-{{ fatura.id }}" class="hover:bg-gray-50 dark:hover:bg-gray-700 fatura-row"
                        data-cliente="{{ fatura.cliente.nome_exibicao }}"
                        data-vencimento="{{ fatura.data_vencimento|date:'Y-m-d' }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                            {{ fatura.numero_documento }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ fatura.cliente.nome_exibicao}}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ fatura.data_emissao|date:"d/m/Y" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% now "Y-m-d" as hoje %}
                            {% if fatura.data_vencimento|date:"Y-m-d" < hoje %} <span class="text-red-600 font-medium">
                                {{ fatura.data_vencimento|date:"d/m/Y" }}</span>
                                {% else %}
                                <span class="text-gray-500 dark:text-gray-400">{{ fatura.data_vencimento|date:"d/m/Y"
                                    }}</span>
                                {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                            {{ fatura.total|floatformat:2 }} Kz
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ fatura.valor_pago|floatformat:2 }} Kz
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">
                            <span class="text-red-600">{{ fatura.saldo|floatformat:2 }} Kz</span>

                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% now "Y-m-d" as hoje %}
                            {% with vencimento=fatura.data_vencimento|date:"Y-m-d" %}
                            {% if vencimento < hoje %} <span class="status-badge status-vencida">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Vencida
                                </span>
                                {% elif vencimento|timeuntil|slice:":1" <= "7" %} <span
                                    class="status-badge status-vencendo">
                                    <i class="fas fa-clock mr-1"></i>Vencendo
                                    </span>
                                    {% else %}
                                    <span class="status-badge status-futura">
                                        <i class="fas fa-calendar-check mr-1"></i>Futura
                                    </span>
                                    {% endif %}
                                    {% endwith %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="liquidarFatura({{ fatura.id }})" class="btn-liquidar">
                                <i class="fas fa-money-bill-wave mr-1"></i>Liquidar
                            </button>
                            <a href="#"
                                class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-smile text-4xl text-green-400 mb-3"></i>
                                <p class="text-lg font-medium">Parabéns! Não há faturas pendentes</p>
                                <p class="text-sm">Todas as faturas estão quitadas ou não há faturas a crédito criadas
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Toast para notificações -->
    <div id="toast" class="hidden fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50">
    </div>
</div>

<script>
    function showToast(mensagem, cor = "#10b981") {
        const toast = document.getElementById("toast");
        toast.textContent = mensagem;
        toast.style.backgroundColor = cor;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3000);
    }

    function atualizarDados() {
        showToast("Dados atualizados!", "#22c55e");
        location.reload();
    }

    function filtrarFaturas() {
        const filtroStatus = document.getElementById('filtroStatus').value;
        const filtroCliente = document.getElementById('filtroCliente').value.toLowerCase();
        const hoje = new Date().toISOString().split('T')[0];
        const seteProximosDias = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

        const rows = document.querySelectorAll('.fatura-row');
        let vencidas = 0, vencendo = 0, futuras = 0;

        rows.forEach(row => {
            const clienteNome = row.getAttribute('data-cliente');
            const vencimento = row.getAttribute('data-vencimento');
            let statusFatura = '';

            // Determinar status da fatura
            if (vencimento < hoje) {
                statusFatura = 'vencida';
                vencidas++;
            } else if (vencimento <= seteProximosDias) {
                statusFatura = 'vencendo';
                vencendo++;
            } else {
                statusFatura = 'futura';
                futuras++;
            }

            // Aplicar filtros
            let mostrar = true;

            if (filtroStatus && filtroStatus !== statusFatura) {
                mostrar = false;
            }

            if (filtroCliente && !clienteNome.includes(filtroCliente)) {
                mostrar = false;
            }

            row.style.display = mostrar ? '' : 'none';
        });

        // Atualizar contadores
        document.getElementById('faturas-vencidas').textContent = vencidas;
        document.getElementById('faturas-vencendo').textContent = vencendo;
        document.getElementById('faturas-futuras').textContent = futuras;
    }

    function limparFiltros() {
        document.getElementById('filtroStatus').value = '';
        document.getElementById('filtroCliente').value = '';
        filtrarFaturas();
    }

    // O CSRF Token é essencial para requisições POST seguras no Django
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function liquidarFatura(faturaId) {
        if (confirm('Deseja liquidar esta fatura? Esta ação criará um recibo de pagamento.')) {

            // 1. URL do Endpoint Django
            const url = `/vendas/api/liquidar-fatura/${faturaId}/`;
            const csrftoken = getCookie('csrftoken');

            showToast('Processando liquidação...', "#f59e0b");

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken, // Incluir o token de segurança
                },
                // Não é necessário enviar dados adicionais, o faturaId está na URL.
                // Se fosse um pagamento parcial, incluiríamos 'valor': X.XX
            })
                .then(response => {
                    if (!response.ok) {
                        // Se a resposta for um erro HTTP (4xx, 5xx), lançamos um erro.
                        throw new Error('Erro na liquidação. Verifique as permissões ou status da fatura.');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast(`Fatura ${data.numero_documento} liquidada com sucesso! Recibo Nº ${data.numero_documento} criado.`, "#10b981");
                        // Remove a linha da tabela (ou atualiza o status)
                        document.getElementById(`fatura-row-${faturaId}`).remove();
                        // Opcional: Recarregue a página para recontar os cards
                        setTimeout(() => location.reload(), 2000);

                    } else {
                        // Caso a View retorne success=false (ex: status inválido)
                        showToast(`Falha na liquidação: ${data.message}`, "#dc2626");
                    }
                })
                .catch(error => {
                    console.error('Erro de rede ou servidor:', error);
                    showToast(`ERRO: ${error.message}`, "#dc2626");
                });
        }
    }

    // Calcular estatísticas iniciais
    document.addEventListener('DOMContentLoaded', function () {
        filtrarFaturas();
    });
</script>
{% endblock %}